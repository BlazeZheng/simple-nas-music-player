<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>光辉永恒播放器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; }
        .glass-bar { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .glass-bottom { background: rgba(15, 23, 42, 0.95); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-panel { background: rgba(30, 41, 59, 0.4); border-right: 1px solid rgba(255, 255, 255, 0.05); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .lyric-line { transition: all 0.3s ease; opacity: 0.4; transform: scale(0.95); filter: blur(0.5px); }
        .lyric-active { opacity: 1; transform: scale(1.1); font-weight: bold; color: #a855f7; filter: blur(0); text-shadow: 0 0 10px rgba(168, 85, 247, 0.5); }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spin-slow { animation: spin 20s linear infinite; }
        .paused-anim { animation-play-state: paused; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .cover-container { max-height: 50vh; }
        .cover-image { max-height: 100%; object-fit: contain; }
        .song-item.current-song { background: rgba(168, 85, 247, 0.15); border: 1px solid rgba(168, 85, 247, 0.3); }
    </style>
</head>
<body class="text-slate-200 h-screen flex flex-col overflow-hidden font-sans selection:bg-purple-500 selection:text-white">
    <div id="app" class="flex flex-col h-full">
        
        <header class="h-16 glass-bar flex items-center justify-between px-6 z-20 shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center shadow-lg shadow-purple-500/30">
                    <i class="ri-music-2-fill text-white"></i>
                </div>
                <h1 class="text-lg font-bold bg-gradient-to-r from-white to-slate-400 bg-clip-text text-transparent">
                    光辉永恒没事瞎写的播放器
                </h1>
            </div>
            <div class="text-xs text-slate-500 font-mono bg-slate-800/50 px-3 py-1 rounded-full border border-slate-700">
                NAS LOCAL LIBRARY · {{ songs.length }} TRACKS
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden relative">
            
            <!-- 左侧：播放列表 -->
            <aside class="w-1/4 min-w-[300px] glass-panel flex flex-col z-10 bg-slate-900/50">
                <div class="p-3 border-b border-slate-700/30 flex justify-between items-center">
                    <div class="text-sm text-slate-500 flex items-center gap-2">
                        <i class="ri-database-2-line"></i>
                        <span v-if="songs.length === 0">正在扫描...</span>
                        <span v-else>{{ songs.length }} 首歌曲</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <!-- 排序按钮 -->
                        <button @click="setSort('title')" :class="{'text-purple-400': sortBy === 'title'}" 
                                class="p-1 hover:text-white transition-colors" title="按歌名排序 (快捷键: F1)">
                            <i :class="sortBy === 'title' && sortOrder === 'desc' ? 'ri-music-2-line rotate-180' : 'ri-music-2-line'"></i>
                        </button>
                        <button @click="setSort('artist')" :class="{'text-purple-400': sortBy === 'artist'}" 
                                class="p-1 hover:text-white transition-colors" title="按歌手排序 (快捷键: F2)">
                            <i :class="sortBy === 'artist' && sortOrder === 'desc' ? 'ri-user-3-line rotate-180' : 'ri-user-3-line'"></i>
                        </button>
                        <button @click="setSort('album')" :class="{'text-purple-400': sortBy === 'album'}" 
                                class="p-1 hover:text-white transition-colors" title="按专辑排序 (快捷键: F3)">
                            <i :class="sortBy === 'album' && sortOrder === 'desc' ? 'ri-album-line rotate-180' : 'ri-album-line'"></i>
                        </button>
                        <button @click="refreshList" class="p-1 hover:text-white transition-colors" title="刷新列表 (快捷键: F5)">
                            <i class="ri-refresh-line"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex-1 flex overflow-hidden">
                    <!-- 歌曲列表 -->
                    <div ref="songListContainer" class="flex-1 overflow-y-auto p-2 space-y-1 relative no-scrollbar">
                        <div v-for="(song, index) in sortedSongs" :key="index" @click="playSong(song)" 
                             :data-index="index" :data-path="song.path" class="song-item p-3 rounded-lg cursor-pointer flex items-center group transition-all hover:bg-white/5 border border-transparent"
                             :class="{'current-song': currentSong && currentSong.path === song.path}">
                            <div class="text-sm truncate flex-1">
                                <div class="font-medium transition-colors" :class="currentSong && currentSong.path === song.path ? 'text-purple-400' : 'text-slate-300'">
                                    {{ song.title }}
                                </div>
                                <div class="text-xs text-slate-500 group-hover:text-slate-400">
                                    {{ song.artist }} • {{ song.album }}
                                </div>
                            </div>
                            <div v-if="currentSong && currentSong.path === song.path" class="text-purple-400 animate-pulse">
                                <i class="ri-sound-module-fill"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- A-Z 索引条 -->
                    <div class="w-6 flex flex-col items-center py-2 space-y-1 text-xs text-slate-500 overflow-y-auto no-scrollbar">
                        <div v-for="letter in indexLetters" :key="letter" 
                             @click="scrollToLetter(letter)"
                             class="cursor-pointer hover:text-purple-400 transition-colors w-4 h-4 flex items-center justify-center rounded hover:bg-white/5">
                            {{ letter }}
                        </div>
                    </div>
                </div>
            </aside>

            <!-- 中间：视觉与歌词 -->
            <main class="flex-1 flex flex-col items-center justify-center bg-slate-950 relative overflow-hidden">
                <div class="absolute inset-0 bg-cover bg-center opacity-30 blur-3xl scale-125 transition-all duration-1000"
                     :style="{ backgroundImage: `url(${displayCover})` }"></div>
                <div class="absolute inset-0 bg-gradient-to-b from-slate-950/80 via-slate-950/60 to-slate-950/90"></div>

                <div ref="lyricsContainer" class="w-full h-full overflow-y-auto text-center p-10 space-y-6 z-10 relative scroll-smooth no-scrollbar">
                    
                    <div v-if="currentSong" class="py-6 flex flex-col items-center">
                        <div class="relative w-72 h-72 group">
                            <div class="absolute inset-1 rounded-full bg-black border-[6px] border-slate-800 shadow-2xl flex items-center justify-center"
                                 :class="['spin-slow', !isPlaying ? 'paused-anim' : '']">
                                <img :src="displayCover" class="w-full h-full rounded-full object-cover p-[2px]" :key="displayCover">
                                <div class="absolute w-8 h-8 bg-slate-900 rounded-full border border-slate-700"></div>
                            </div>
                        </div>
                        <div class="mt-8 mb-2 text-2xl font-bold text-white tracking-wide">{{ currentSong.title }}</div>
                        <div class="text-purple-400 text-sm font-medium tracking-widest uppercase">{{ currentSong.artist }}</div>
                    </div>
                    
                    <div v-if="!currentSong" class="h-full flex flex-col items-center justify-center text-slate-600">
                        <div class="w-20 h-20 rounded-full bg-slate-800 flex items-center justify-center mb-4 animate-bounce">
                            <i class="ri-disc-line text-4xl"></i>
                        </div>
                        <p>正在读取 NAS 音乐库...</p>
                    </div>

                    <div v-else class="pb-[40vh] max-w-2xl mx-auto">
                        <p v-if="parsedLyrics.length === 0" class="text-slate-500 py-10 italic">~ 暂无歌词 / 后台搜索中(刷新页面查看) ~</p>
                        <div v-for="(line, idx) in parsedLyrics" :key="idx" :id="'line-' + idx"
                           class="lyric-line py-3 text-lg md:text-xl cursor-pointer hover:opacity-80 hover:text-white"
                           :class="{'lyric-active': currentLineIndex === idx}"
                           @click="seekTo(line.time)">
                           {{ line.text }}
                        </div>
                    </div>
                </div>
            </main>

            <!-- 右侧：详细信息 -->
            <aside class="w-1/4 min-w-[250px] glass-panel border-l border-r-0 border-slate-700/50 flex flex-col p-6 z-10 bg-slate-900/60 backdrop-blur-md">
                <div class="flex items-center gap-2 text-slate-400 mb-6 pb-4 border-b border-white/5">
                    <i class="ri-information-line"></i>
                    <h2 class="text-xs font-bold uppercase tracking-widest">Track Info</h2>
                </div>
                <div v-if="currentSong" class="space-y-6 animate-fade-in flex-1 flex flex-col">
                    <div class="cover-container flex justify-center">
                        <img :src="displayCover" class="cover-image rounded-lg shadow-2xl border border-white/10" :key="displayCover">
                    </div>
                    <div class="space-y-4 font-mono text-sm flex-1 overflow-y-auto">
                        <div class="bg-white/5 p-3 rounded-lg border border-white/5">
                            <div class="text-xs text-slate-500 mb-1">Title</div>
                            <div class="font-bold text-white truncate">{{ currentSong.title }}</div>
                        </div>
                        <div class="bg-white/5 p-3 rounded-lg border border-white/5">
                            <div class="text-xs text-slate-500 mb-1">Artist</div>
                            <div class="text-slate-300 truncate">{{ currentSong.artist }}</div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-white/5 p-3 rounded-lg border border-white/5">
                                <div class="text-xs text-slate-500 mb-1">Album</div>
                                <div class="text-slate-300 truncate text-xs">{{ currentSong.album }}</div>
                            </div>
                            <div class="bg-white/5 p-3 rounded-lg border border-white/5">
                                <div class="text-xs text-slate-500 mb-1">Format</div>
                                <div class="text-slate-300 uppercase text-xs">{{ currentSong.filename.split('.').pop() }} / {{ currentSong.size }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- 底部控制栏 -->
        <footer class="glass-bottom h-24 px-6 flex items-center justify-between z-50 shrink-0" v-if="currentSong">
            <div class="w-1/3 flex items-center gap-4">
                <div class="relative group cursor-pointer" @click="togglePlay">
                    <img :src="displayCover" class="w-14 h-14 rounded-md shadow-lg object-cover border border-white/10" :key="displayCover">
                    <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-md">
                         <i :class="isPlaying ? 'ri-pause-fill' : 'ri-play-fill'" class="text-white"></i>
                    </div>
                </div>
                <div class="overflow-hidden">
                    <div class="font-bold truncate text-white text-sm">{{ currentSong.title }}</div>
                    <div class="text-xs text-slate-400 truncate">{{ currentSong.artist }}</div>
                </div>
            </div>

            <div class="w-1/3 flex flex-col items-center justify-center">
                <div class="flex items-center gap-8 mb-2">
                    <button @click="toggleLoop" :title="getLoopTitle()"
                            :class="loopMode > 0 ? 'text-purple-400 drop-shadow-[0_0_8px_rgba(168,85,247,0.5)]' : 'text-slate-500 hover:text-slate-300'">
                        <i :class="loopMode === 2 ? 'ri-repeat-one-line' : 'ri-repeat-2-line'" class="text-lg"></i>
                    </button>
                    <button @click="prevSong" class="text-slate-300 hover:text-white hover:scale-110 transition-transform active:scale-95" title="上一曲 (快捷键: PageUp)">
                        <i class="ri-skip-back-fill text-2xl"></i>
                    </button>
                    <button @click="togglePlay" class="w-12 h-12 rounded-full bg-white text-black flex items-center justify-center hover:scale-105 transition-transform shadow-lg shadow-purple-500/20 active:scale-95" title="播放/暂停 (快捷键: 空格)">
                        <i :class="isPlaying ? 'ri-pause-fill' : 'ri-play-fill'" class="text-2xl ml-0.5"></i>
                    </button>
                    <button @click="nextSong(true)" class="text-slate-300 hover:text-white hover:scale-110 transition-transform active:scale-95" title="下一曲 (快捷键: PageDown)">
                        <i class="ri-skip-forward-fill text-2xl"></i>
                    </button>
                    <button @click="toggleShuffle" :title="'随机播放' + (isShuffle ? ' (开)' : ' (关)') + ' (快捷键: S)'"
                            :class="isShuffle ? 'text-purple-400 drop-shadow-[0_0_8px_rgba(168,85,247,0.5)]' : 'text-slate-500 hover:text-slate-300'">
                        <i class="ri-shuffle-line text-lg"></i>
                    </button>
                </div>
                <div class="w-full flex items-center gap-3 text-xs text-slate-500 font-mono">
                    <span class="w-10 text-right">{{ formatTime(currentTime) }}</span>
                    <div class="flex-1 relative h-1 bg-slate-700 rounded-full group cursor-pointer">
                        <div class="absolute h-full bg-purple-500 rounded-full group-hover:bg-purple-400" :style="{width: (currentTime/duration*100)+'%'}"></div>
                        <input type="range" min="0" :max="duration || 0" v-model="currentTime" @input="onSeek" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                    </div>
                    <span class="w-10">{{ formatTime(duration) }}</span>
                </div>
            </div>

            <div class="w-1/3 flex justify-end items-center gap-3">
                <button @click="toggleMute" class="text-slate-400 hover:text-white" title="静音/取消静音 (快捷键: M)">
                    <i :class="volume === 0 ? 'ri-volume-mute-line' : (volume < 0.5 ? 'ri-volume-down-line' : 'ri-volume-up-line')"></i>
                </button>
                <div class="w-24 h-1 bg-slate-700 rounded-full relative overflow-hidden group">
                     <div class="absolute h-full bg-slate-400 rounded-full" :style="{width: (volume*100)+'%'}"></div>
                     <input type="range" min="0" max="1" step="0.01" v-model="volume" @input="updateVolume" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                </div>
            </div>
        </footer>
        <audio ref="audioPlayer" :src="streamUrl" @timeupdate="onTimeUpdate" @loadedmetadata="onLoadedMetadata" @ended="onEnded"></audio>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, nextTick } = Vue
        const DEFAULT_COVER = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23334155'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z'/%3E%3C/svg%3E";

        createApp({
            setup() {
                const songs = ref([])
                const currentSong = ref(null)
                const isPlaying = ref(false)
                const audioPlayer = ref(null)
                const currentTime = ref(0); const duration = ref(0); const volume = ref(1.0)
                const loopMode = ref(1); const isShuffle = ref(true)
                const parsedLyrics = ref([]); const currentLineIndex = ref(-1)
                const lyricsContainer = ref(null)
                const songListContainer = ref(null)
                const sortBy = ref('title') // 默认按歌名排序
                const sortOrder = ref('asc') // 排序顺序
                const flacWatchdog = ref(null) // FLAC看门狗定时器

                // 1. 获取列表并初始化
                const fetchSongs = () => {
                    fetch('/api/songs').then(res => res.json()).then(data => { 
                        const oldPath = currentSong.value?.path // 记住当前播放的，防止刷新后断掉
                        songs.value = data
                        
                        // 如果是第一次加载，随机来一首
                        if (!currentSong.value && songs.value.length > 0) {
                            const randIdx = Math.floor(Math.random() * songs.value.length)
                            playSong(songs.value[randIdx])
                        } 
                        // 如果已经有在播放的，更新一下信息(比如封面刷出来了)
                        else if (currentSong.value) {
                            const newSongInfo = songs.value.find(s => s.path === oldPath)
                            if (newSongInfo) {
                                // 保持状态但更新元数据
                                if(newSongInfo.has_cover !== currentSong.value.has_cover) {
                                    currentSong.value.has_cover = newSongInfo.has_cover
                                }
                                if(newSongInfo.lyrics && !currentSong.value.lyrics) {
                                     currentSong.value.lyrics = newSongInfo.lyrics
                                     parsedLyrics.value = parseLyrics(newSongInfo.lyrics)
                                }
                            }
                        }
                    })
                }
                
                // 启动获取
                fetchSongs()

                const refreshList = () => { fetchSongs() }

                // 排序功能 - 修改为按排序键排序
                const sortedSongs = computed(() => {
                    const songsArray = [...songs.value]
                    
                    return songsArray.sort((a, b) => {
                        let aVal, bVal
                        
                        switch (sortBy.value) {
                            case 'artist':
                                aVal = a.artist_sort || ''
                                bVal = b.artist_sort || ''
                                break
                            case 'album':
                                aVal = a.album_sort || ''
                                bVal = b.album_sort || ''
                                break
                            case 'title':
                            default:
                                aVal = a.title_sort || ''
                                bVal = b.title_sort || ''
                        }
                        
                        // 使用排序键进行比较
                        const comparison = aVal.localeCompare(bVal, 'zh-CN')
                        return sortOrder.value === 'asc' ? comparison : -comparison
                    })
                })

                // 获取当前排序字段的首字母
                const getCurrentInitial = (song) => {
                    switch (sortBy.value) {
                        case 'artist':
                            return song.artist_initial || '#'
                        case 'album':
                            return song.album_initial || '#'
                        case 'title':
                        default:
                            return song.title_initial || '#'
                    }
                }

                // 获取索引字母列表
                const indexLetters = computed(() => {
                    const letters = new Set()
                    sortedSongs.value.forEach(song => {
                        const initial = getCurrentInitial(song)
                        if (initial) {
                            // 只保留字母和#，其他字符都归为#
                            const normalizedInitial = /^[A-Za-z]$/.test(initial) ? initial.toUpperCase() : '#'
                            letters.add(normalizedInitial)
                        }
                    })
                    return Array.from(letters).sort()
                })

                // 滚动到指定字母
                const scrollToLetter = (letter) => {
                    const container = document.querySelector('.overflow-y-auto')
                    const elements = container.querySelectorAll('.song-item')
                    
                    for (let el of elements) {
                        const songIndex = parseInt(el.dataset.index)
                        const songInitial = getCurrentInitial(sortedSongs.value[songIndex])
                        const normalizedInitial = /^[A-Za-z]$/.test(songInitial) ? songInitial.toUpperCase() : '#'
                        if (normalizedInitial === letter) {
                            el.scrollIntoView({ behavior: 'smooth', block: 'start' })
                            break
                        }
                    }
                }

                // 切换排序方式
                const setSort = (field) => {
                    if (sortBy.value === field) {
                        sortOrder.value = sortOrder.value === 'asc' ? 'desc' : 'asc'
                    } else {
                        sortBy.value = field
                        sortOrder.value = 'asc'
                    }
                }

                // 封面: 增加时间戳参数防止缓存导致不更新
                const displayCover = computed(() => {
                    if (currentSong.value && currentSong.value.has_cover) 
                        return `/api/cover?path=${encodeURIComponent(currentSong.value.path)}&t=${Date.now()}`
                    return DEFAULT_COVER
                })

                const parseLyrics = (lrcText) => {
                    if (!lrcText) return []
                    const lines = lrcText.split('\n')
                    const regex = /^\[(\d{2}):(\d{2}\.\d{2,3})\](.*)/
                    const result = []
                    for (const line of lines) {
                        const match = line.match(regex)
                        if (match) {
                            result.push({ time: parseInt(match[1])*60 + parseFloat(match[2]), text: match[3].trim() })
                        }
                    }
                    return result
                }

                const playSong = async (song) => {
                    // 如果点的就是当前这首，不做动作
                    if (currentSong.value && currentSong.value.path === song.path) return

                    currentSong.value = song
                    parsedLyrics.value = [] 
                    
                    if (song.lyrics && song.lyrics.length > 10) {
                        parsedLyrics.value = parseLyrics(song.lyrics)
                    }
                    
                    isPlaying.value = true
                    currentLineIndex.value = -1
                    if(lyricsContainer.value) lyricsContainer.value.scrollTop = 0
                    
                    // 等待DOM更新后滚动到当前歌曲
                    await nextTick()
                    scrollToCurrentSong()
                }

                // 滚动到当前播放的歌曲
                const scrollToCurrentSong = () => {
                    if (!currentSong.value || !songListContainer.value) return
                    
                    const currentSongElement = songListContainer.value.querySelector(`.song-item[data-path="${currentSong.value.path}"]`)
                    if (currentSongElement) {
                        currentSongElement.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center',
                            inline: 'nearest'
                        })
                    }
                }

                const streamUrl = computed(() => currentSong.value ? `/api/stream?path=${encodeURIComponent(currentSong.value.path)}` : '')
                
                const onLoadedMetadata = () => { 
                    duration.value = audioPlayer.value.duration; 
                    const playPromise = audioPlayer.value.play();
                    if (playPromise !== undefined) {
                        playPromise.then(_ => { isPlaying.value = true; }).catch(error => { isPlaying.value = false; });
                    }
                    
                    // 启动FLAC看门狗
                    startFlacWatchdog()
                }

                // FLAC看门狗 - 解决FLAC不能自动切歌的问题
                const startFlacWatchdog = () => {
                    // 清除之前的看门狗
                    if (flacWatchdog.value) {
                        clearInterval(flacWatchdog.value)
                    }
                    
                    // 如果是FLAC文件，启动看门狗
                    if (currentSong.value && currentSong.value.filename.toLowerCase().endsWith('.flac')) {
                        flacWatchdog.value = setInterval(() => {
                            if (audioPlayer.value && duration.value > 0) {
                                // 如果当前时间接近总时长（相差不到1秒），强制切歌
                                if (currentTime.value >= duration.value - 1) {
                                    console.log('FLAC看门狗：检测到歌曲即将结束，强制切歌')
                                    onEnded()
                                    clearInterval(flacWatchdog.value)
                                }
                            }
                        }, 500) // 每500毫秒检查一次
                    }
                }

                const togglePlay = () => { 
                    const audio = audioPlayer.value; 
                    if(audio.paused){
                        audio.play();
                        isPlaying.value=true;
                        // 重新启动FLAC看门狗
                        startFlacWatchdog();
                    } else {
                        audio.pause();
                        isPlaying.value=false;
                    } 
                }
                
                const toggleLoop = () => loopMode.value = (loopMode.value + 1) % 3
                const getLoopTitle = () => {
                    const titles = ['顺序播放 (快捷键: L)', '列表循环 (快捷键: L)', '单曲循环 (快捷键: L)']
                    return titles[loopMode.value]
                }
                const toggleShuffle = () => isShuffle.value = !isShuffle.value
                
                const nextSong = (manual=false) => {
                    if(!songs.value.length) return
                    if(loopMode.value===2 && !manual) { 
                        audioPlayer.value.currentTime=0; 
                        audioPlayer.value.play(); 
                        return 
                    }
                    let nextIdx = 0; 
                    const currIdx = songs.value.findIndex(s => s.path === currentSong.value?.path)
                    if(isShuffle.value) { 
                        do { 
                            nextIdx = Math.floor(Math.random()*songs.value.length) 
                        } while(nextIdx === currIdx && songs.value.length > 1) 
                    } 
                    else { 
                        nextIdx = currIdx + 1; 
                        if(nextIdx >= songs.value.length) { 
                            if(loopMode.value===0) return; 
                            nextIdx = 0 
                        } 
                    }
                    playSong(songs.value[nextIdx])
                }
                
                const prevSong = () => { 
                    const currIdx = songs.value.findIndex(s => s.path === currentSong.value?.path); 
                    let prevIdx = currIdx - 1; 
                    if(prevIdx < 0) prevIdx = songs.value.length - 1; 
                    playSong(songs.value[prevIdx]) 
                }
                
                const onTimeUpdate = () => { 
                    const audio = audioPlayer.value; 
                    currentTime.value = audio.currentTime; 
                    if(parsedLyrics.value.length){ 
                        let idx = parsedLyrics.value.findIndex(l => l.time > audio.currentTime) - 1; 
                        if(idx < 0 && audio.currentTime >= parsedLyrics.value[0].time) idx = 0; 
                        if(idx === -2) idx = parsedLyrics.value.length - 1; 
                        if(idx !== currentLineIndex.value) { 
                            currentLineIndex.value = idx; 
                            scrollToLyric(idx) 
                        } 
                    } 
                }
                
                const scrollToLyric = (idx) => { 
                    const el = document.getElementById('line-'+idx); 
                    if(el) el.scrollIntoView({behavior:'smooth', block:'center'}) 
                }
                
                const onEnded = () => {
                    // 清除FLAC看门狗
                    if (flacWatchdog.value) {
                        clearInterval(flacWatchdog.value)
                    }
                    nextSong(false) 
                }
                
                const onSeek = () => audioPlayer.value.currentTime = currentTime.value
                const seekTo = (t) => { 
                    audioPlayer.value.currentTime = t; 
                    audioPlayer.value.play(); 
                    isPlaying.value = true;
                    // 重新启动FLAC看门狗
                    startFlacWatchdog();
                }
                
                const seekForward = () => { 
                    if(audioPlayer.value) { 
                        audioPlayer.value.currentTime = Math.min(audioPlayer.value.currentTime + 10, duration.value); 
                    } 
                }
                
                const seekBackward = () => { 
                    if(audioPlayer.value) { 
                        audioPlayer.value.currentTime = Math.max(audioPlayer.value.currentTime - 10, 0); 
                    } 
                }
                
                const formatTime = (s) => { 
                    if(!s) return "00:00"; 
                    const m=Math.floor(s/60); 
                    const sec=Math.floor(s%60); 
                    return `${m}:${sec.toString().padStart(2,'0')}` 
                }
                
                const updateVolume = () => { audioPlayer.value.volume = volume.value }
                
                const toggleMute = () => { 
                    if(volume.value > 0) { 
                        audioPlayer.value.dataset.prevVol = volume.value; 
                        volume.value = 0; 
                    } else { 
                        volume.value = audioPlayer.value.dataset.prevVol || 1.0; 
                    } 
                    audioPlayer.value.volume = volume.value 
                }

                // 快捷键处理
                const handleKeyDown = (e) => {
                    // 忽略在输入框中的按键
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return
                    
                    switch(e.key) {
                        case ' ': // 空格键 - 播放/暂停
                            e.preventDefault()
                            togglePlay()
                            break
                        case 'PageUp': // PageUp - 上一曲
                            e.preventDefault()
                            prevSong()
                            break
                        case 'PageDown': // PageDown - 下一曲
                            e.preventDefault()
                            nextSong(true)
                            break
                        case 'ArrowLeft': // 左箭头 - 后退10秒
                            e.preventDefault()
                            seekBackward()
                            break
                        case 'ArrowRight': // 右箭头 - 前进10秒
                            e.preventDefault()
                            seekForward()
                            break
                        case 'l': // L键 - 切换循环模式
                        case 'L':
                            e.preventDefault()
                            toggleLoop()
                            break
                        case 's': // S键 - 切换随机播放
                        case 'S':
                            e.preventDefault()
                            toggleShuffle()
                            break
                        case 'm': // M键 - 静音/取消静音
                        case 'M':
                            e.preventDefault()
                            toggleMute()
                            break
                        case 'F1': // F1 - 按歌名排序
                            e.preventDefault()
                            setSort('title')
                            break
                        case 'F2': // F2 - 按歌手排序
                            e.preventDefault()
                            setSort('artist')
                            break
                        case 'F3': // F3 - 按专辑排序
                            e.preventDefault()
                            setSort('album')
                            break
                        case 'F5': // F5 - 刷新列表
                            e.preventDefault()
                            refreshList()
                            break
                    }
                }

                // 生命周期钩子
                onMounted(() => {
                    document.addEventListener('keydown', handleKeyDown)
                })

                onUnmounted(() => {
                    document.removeEventListener('keydown', handleKeyDown)
                    // 清除FLAC看门狗
                    if (flacWatchdog.value) {
                        clearInterval(flacWatchdog.value)
                    }
                })

                return { 
                    songs, currentSong, isPlaying, audioPlayer, streamUrl, currentTime, duration, volume, 
                    loopMode, isShuffle, parsedLyrics, currentLineIndex, lyricsContainer, songListContainer,
                    sortBy, sortOrder, sortedSongs, indexLetters,
                    playSong, togglePlay, nextSong, prevSong, toggleLoop, toggleShuffle, 
                    onTimeUpdate, onLoadedMetadata, onEnded, onSeek, seekTo, formatTime, 
                    displayCover, updateVolume, toggleMute, refreshList,
                    setSort, scrollToLetter, getCurrentInitial, getLoopTitle,
                    seekForward, seekBackward, scrollToCurrentSong
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
